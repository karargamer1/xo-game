<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑÿπÿ®ÿ© XO ÿ£ŸàŸÜŸÑÿßŸäŸÜ - ÿ™ŸäŸÉ ÿ™ÿßŸÉ ÿ™Ÿà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .developer-credit {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            to {
                box-shadow: 0 4px 20px rgba(78, 205, 196, 0.6);
            }
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .lobby {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .room-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .player-list {
            margin: 15px 0;
            text-align: right;
        }

        .player-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-right: 4px solid #667eea;
        }

        .player-x {
            border-right-color: #ff6b6b;
        }

        .player-o {
            border-right-color: #4ecdc4;
        }

        .player-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .player-turn {
            font-size: 1.3em;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .player-x {
            background: #ff6b6b;
            color: white;
        }

        .player-o {
            background: #4ecdc4;
            color: white;
        }

        .waiting {
            background: #ffc107;
            color: black;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin: 20px 0;
            background: #333;
            padding: 10px;
            border-radius: 10px;
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cell:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .cell.x {
            color: #ff6b6b;
        }

        .cell.o {
            color: #4ecdc4;
        }

        .cell.win {
            background: #fff3cd;
            animation: pulse 0.5s ease-in-out;
        }

        .cell.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: #dc3545;
        }

        .reset-btn:hover {
            background: #c82333;
        }

        .invite-btn {
            background: #28a745;
        }

        .invite-btn:hover {
            background: #218838;
        }

        .message {
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .win-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .draw-message {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: none;
            margin: 10px 0;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-container {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .chat-input button {
            padding: 10px 20px;
        }

        .message-item {
            margin: 5px 0;
            padding: 8px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .message-sender {
            font-weight: bold;
            color: #667eea;
        }

        .footer {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .auto-join-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #b3d9ff;
        }

        /* ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ® ŸÑŸÑŸáŸàÿßÿ™ŸÅ */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .cell {
                font-size: 2.5em;
            }
            
            button {
                padding: 10px 20px;
                font-size: 1em;
            }
            
            .connection-status {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
            }

            .developer-credit {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">
        üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ
    </div>

    <div class="container">
        <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± -->
        <div class="developer-credit">
            üöÄ ŸÖÿ∑Ÿàÿ± ÿßŸÑŸÑÿπÿ®ÿ©: ŸÉÿ±ÿßÿ±
        </div>

        <h1>üéÆ ŸÑÿπÿ®ÿ© XO ÿ£ŸàŸÜŸÑÿßŸäŸÜ</h1>
        
        <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
        <div class="auto-join-section" id="auto-join-section">
            <h3>üéØ ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÑÿπÿ®</h3>
            <div class="controls">
                <button onclick="createNewRoom()">üÜï ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©</button>
                <button onclick="joinRandomRoom()">üé≤ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ∫ÿ±ŸÅÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©</button>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>
        
        <div class="lobby" id="lobby" style="display: none;">
            <h3>üë• ÿ∫ÿ±ŸÅÿ© ÿßŸÑŸÑÿπÿ®</h3>
            <div class="room-code" id="room-code">ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©...</div>
            
            <div class="player-list" id="player-list">
                <div class="player-item waiting">ÿ¨ÿßÿ±Ÿä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ...</div>
            </div>
            
            <button class="invite-btn" onclick="copyRoomLink()" id="invite-btn">
                üìß ÿØÿπŸàÿ© ÿµÿØŸäŸÇ
            </button>
        </div>

        <div class="player-info" id="game-info" style="display: none;">
            <div class="player-turn waiting" id="player-turn">ÿ¨ÿßÿ±Ÿä ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©...</div>
        </div>

        <div class="game-board" id="board" style="display: none;">
            <!-- ÿßŸÑÿÆŸÑÿßŸäÿß ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿáÿß ÿ®ÿßŸÑÿ¨ÿßŸÅÿßÿ≥ŸÉÿ±Ÿäÿ®ÿ™ -->
        </div>

        <div class="message win-message" id="win-message"></div>
        <div class="message draw-message" id="draw-message">ÿ™ÿπÿßÿØŸÑ! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</div>

        <div class="controls" id="game-controls" style="display: none;">
            <button onclick="resetGame()">ŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
            <button class="reset-btn" onclick="leaveRoom()">üîÑ ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
        </div>

        <div class="chat-container" id="chat-container" style="display: none;">
            <h4>üí¨ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</h4>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." maxlength="100">
                <button onclick="sendMessage()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
            </div>
        </div>

        <!-- ÿ™ÿ∞ŸäŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© -->
        <div class="footer">
            <p>ÿ™ŸÖ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© <strong>ŸÉÿ±ÿßÿ±</strong> | ŸÑÿπÿ®ÿ© XO ÿ£ŸàŸÜŸÑÿßŸäŸÜ ŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ</p>
            <p>üíª ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑŸÑÿπÿ® ŸÖÿπ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä!</p>
        </div>
    </div>

    <script>
        // ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        let currentPlayer = 'X';
        let gameBoard = ['', '', '', '', '', '', '', '', ''];
        let gameActive = false;
        let playerId = null;
        let playerSymbol = null;
        let roomId = null;
        let players = [];
        let isMyTurn = false;

        // ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑŸÅŸàÿ≤
        const winPatterns = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // ÿµŸÅŸàŸÅ
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // ÿ£ÿπŸÖÿØÿ©
            [0, 4, 8], [2, 4, 6]             // ÿ£ŸÇÿ∑ÿßÿ±
        ];

        // ŸÖÿ≠ÿßŸÉÿßÿ© ÿÆÿßÿØŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ LocalStorage (ŸÑŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©)
        class GameServer {
            constructor() {
                this.rooms = new Map();
                this.setupStorageListener();
                this.loadFromStorage();
            }

            // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©
            createRoom() {
                const roomId = this.generateRoomId();
                const room = {
                    id: roomId,
                    players: [],
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'X',
                    gameActive: false,
                    winner: null,
                    chat: [],
                    createdAt: new Date().toISOString()
                };
                
                this.rooms.set(roomId, room);
                this.saveToStorage();
                console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©:', roomId);
                return roomId;
            }

            // ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ©
            joinRoom(roomId, playerName) {
                const room = this.rooms.get(roomId);
                if (!room) {
                    console.log('‚ùå ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', roomId);
                    return null;
                }

                if (room.players.length >= 2) {
                    console.log('‚ùå ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸÖÿ™ŸÑÿ¶ÿ©:', roomId);
                    return null;
                }

                const playerId = this.generatePlayerId();
                const player = {
                    id: playerId,
                    name: playerName || `ŸÑÿßÿπÿ® ${room.players.length + 1}`,
                    symbol: room.players.length === 0 ? 'X' : 'O'
                };

                room.players.push(player);
                
                if (room.players.length === 2) {
                    room.gameActive = true;
                }

                this.saveToStorage();
                console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿ∫ÿ±ŸÅÿ©:', roomId, 'ÿßŸÑŸÑÿßÿπÿ®:', player.name);
                return { playerId, symbol: player.symbol, room };
            }

            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∫ÿ±ŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ©
            findAvailableRoom() {
                const now = new Date();
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÇÿØŸäŸÖÿ© (ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 10 ÿØŸÇÿßÿ¶ŸÇ)
                this.cleanOldRooms();

                for (let [roomId, room] of this.rooms) {
                    if (room.players.length === 1 && !room.gameActive) {
                        // ÿ™ÿ≠ŸÇŸÇ ÿ£ŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÑŸäÿ≥ÿ™ ŸÇÿØŸäŸÖÿ©
                        const roomAge = now - new Date(room.createdAt);
                        if (roomAge < 10 * 60 * 1000) { // 10 ÿØŸÇÿßÿ¶ŸÇ
                            console.log('üéØ Ÿàÿ¨ÿØÿ™ ÿ∫ÿ±ŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ©:', roomId);
                            return roomId;
                        }
                    }
                }
                console.log('‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∫ÿ±ŸÅ ŸÖÿ™ÿßÿ≠ÿ©');
                return null;
            }

            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÇÿØŸäŸÖÿ©
            cleanOldRooms() {
                const now = new Date();
                for (let [roomId, room] of this.rooms) {
                    const roomAge = now - new Date(room.createdAt);
                    if (roomAge > 30 * 60 * 1000) { // 30 ÿØŸÇŸäŸÇÿ©
                        this.rooms.delete(roomId);
                        console.log('üßπ ÿ™ŸÖ ÿ™ŸÜÿ∏ŸäŸÅ ÿ∫ÿ±ŸÅÿ© ŸÇÿØŸäŸÖÿ©:', roomId);
                    }
                }
                this.saveToStorage();
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
            makeMove(roomId, playerId, cellIndex) {
                const room = this.rooms.get(roomId);
                if (!room || !room.gameActive) return false;

                const player = room.players.find(p => p.id === playerId);
                if (!player || player.symbol !== room.currentPlayer) return false;

                if (room.board[cellIndex] !== '') return false;

                room.board[cellIndex] = player.symbol;

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÅŸàÿ≤
                if (this.checkWin(room.board)) {
                    room.winner = player.symbol;
                    room.gameActive = false;
                } else if (this.checkDraw(room.board)) {
                    room.winner = 'draw';
                    room.gameActive = false;
                } else {
                    room.currentPlayer = room.currentPlayer === 'X' ? 'O' : 'X';
                }

                this.saveToStorage();
                return true;
            }

            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ©
            resetGame(roomId) {
                const room = this.rooms.get(roomId);
                if (!room) return false;

                room.board = ['', '', '', '', '', '', '', '', ''];
                room.currentPlayer = 'X';
                room.winner = null;
                room.gameActive = room.players.length === 2;

                this.saveToStorage();
                return true;
            }

            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ≠ÿßÿØÿ´ÿ©
            sendMessage(roomId, playerId, message) {
                const room = this.rooms.get(roomId);
                if (!room) return false;

                const player = room.players.find(p => p.id === playerId);
                if (!player) return false;

                room.chat.push({
                    playerId,
                    playerName: player.name,
                    message,
                    timestamp: new Date().toLocaleTimeString()
                });

                // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ¢ÿÆÿ± 50 ÿ±ÿ≥ÿßŸÑÿ© ŸÅŸÇÿ∑
                if (room.chat.length > 50) {
                    room.chat = room.chat.slice(-50);
                }

                this.saveToStorage();
                return true;
            }

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ©
            getRoomUpdate(roomId) {
                return this.rooms.get(roomId);
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ÿ∫ÿ±ŸÅÿ©
            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÑÿßÿπÿ®
            generatePlayerId() {
                return Math.random().toString(36).substring(2, 10);
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÅŸàÿ≤
            checkWin(board) {
                return winPatterns.some(pattern => {
                    const [a, b, c] = pattern;
                    return board[a] && board[a] === board[b] && board[a] === board[c];
                });
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿπÿßÿØŸÑ
            checkDraw(board) {
                return board.every(cell => cell !== '');
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿ≠ŸÅÿ∏ ŸÅŸä LocalStorage
            saveToStorage() {
                const roomsObj = Object.fromEntries(this.rooms);
                localStorage.setItem('xo_online_rooms', JSON.stringify(roomsObj));
            }

            // ŸÖÿ≥ÿßÿπÿØÿ© - ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ LocalStorage
            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('xo_online_rooms');
                    if (stored) {
                        const roomsObj = JSON.parse(stored);
                        this.rooms = new Map(Object.entries(roomsObj));
                        console.log('üìÇ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ ŸÖŸÜ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ:', this.rooms.size);
                    }
                } catch (error) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    this.rooms = new Map();
                }
            }

            // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ LocalStorage (ŸÑŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä)
            setupStorageListener() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'xo_online_rooms' && roomId) {
                        console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ');
                        this.onRoomUpdate(roomId);
                    }
                });

                // ŸÖÿ≠ÿßŸÉÿßÿ© ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä
                setInterval(() => {
                    if (roomId) {
                        this.onRoomUpdate(roomId);
                    }
                }, 1000);
            }

            onRoomUpdate(roomId) {
                const room = this.getRoomUpdate(roomId);
                if (room && window.onRoomUpdate) {
                    window.onRoomUpdate(room);
                }
            }
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿßÿØŸÖ ÿßŸÑŸÑÿπÿ®ÿ©
        const gameServer = new GameServer();

        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿÆÿ∑ÿ£
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©
        function createNewRoom() {
            hideAllSections();
            document.getElementById('lobby').style.display = 'block';
            
            roomId = gameServer.createRoom();
            const result = gameServer.joinRoom(roomId, 'ÿßŸÑŸÑÿßÿπÿ® 1');
            
            if (result) {
                playerId = result.playerId;
                playerSymbol = result.symbol;
                updateRoomUI();
                updateURL();
                initGameBoard();
            } else {
                showError('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©');
            }
        }

        // ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ∫ÿ±ŸÅÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
        function joinRandomRoom() {
            hideAllSections();
            
            const availableRoom = gameServer.findAvailableRoom();
            if (availableRoom) {
                const result = gameServer.joinRoom(availableRoom, 'ÿßŸÑŸÑÿßÿπÿ® 2');
                if (result) {
                    roomId = availableRoom;
                    playerId = result.playerId;
                    playerSymbol = result.symbol;
                    updateRoomUI();
                    updateURL();
                    initGameBoard();
                    showError('‚úÖ ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿ∫ÿ±ŸÅÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                } else {
                    showError('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿ∫ÿ±ŸÅÿ©');
                    createNewRoom(); // ÿ£ŸÜÿ¥ÿ¶ ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                }
            } else {
                showError('üéØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∫ÿ±ŸÅ ŸÖÿ™ÿßÿ≠ÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©...');
                createNewRoom(); // ÿ£ŸÜÿ¥ÿ¶ ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
        function hideAllSections() {
            document.getElementById('auto-join-section').style.display = 'none';
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-info').style.display = 'none';
            document.getElementById('board').style.display = 'none';
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
        }

        // ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        function initGameBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = 'cell';
                cell.setAttribute('data-index', i);
                cell.addEventListener('click', () => handleCellClick(i));
                board.appendChild(cell);
            }

            updateConnectionStatus(true);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©
        function updateRoomUI() {
            const room = gameServer.getRoomUpdate(roomId);
            if (!room) {
                showError('‚ùå ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÑŸÖ ÿ™ÿπÿØ ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }

            document.getElementById('room-code').textContent = room.id;
            updatePlayerList(room.players);
            
            if (room.players.length === 2 && room.gameActive) {
                startGame(room);
            } else {
                showWaitingMessage();
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ
        function updatePlayerList(players) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';

            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item player-${player.symbol.toLowerCase()}`;
                playerItem.textContent = `${player.name} (${player.symbol})`;
                if (player.id === playerId) {
                    playerItem.textContent += ' - ÿ£ŸÜÿ™';
                }
                playerList.appendChild(playerItem);
            });

            if (players.length === 1) {
                const waitingItem = document.createElement('div');
                waitingItem.className = 'player-item waiting';
                waitingItem.textContent = '‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÑÿßÿπÿ® ÿ¢ÿÆÿ±...';
                playerList.appendChild(waitingItem);
            }
        }

        // ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
        function startGame(room) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-info').style.display = 'block';
            document.getElementById('board').style.display = 'grid';
            document.getElementById('game-controls').style.display = 'block';
            document.getElementById('chat-container').style.display = 'block';

            gameActive = room.gameActive;
            updateGameState(room);
        }

        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
        function showWaitingMessage() {
            document.getElementById('player-turn').textContent = '‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÑÿßÿπÿ® ÿ¢ÿÆÿ±...';
            document.getElementById('player-turn').className = 'player-turn waiting';
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        function updateGameState(room) {
            gameBoard = [...room.board];
            currentPlayer = room.currentPlayer;
            isMyTurn = room.gameActive && room.players.find(p => p.id === playerId)?.symbol === room.currentPlayer;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÑŸàÿ≠ÿ©
            updateBoard();

            // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ± ÿßŸÑŸÑÿßÿπÿ®
            updatePlayerTurn();

            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÅŸàÿ≤/ÿßŸÑÿ™ÿπÿßÿØŸÑ
            if (room.winner) {
                if (room.winner === 'draw') {
                    showDrawMessage();
                } else {
                    showWinMessage(room.winner);
                }
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
            updateChat(room.chat);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÑŸàÿ≠ÿ©
        function updateBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                cell.textContent = gameBoard[index];
                cell.className = 'cell';
                
                if (gameBoard[index]) {
                    cell.classList.add(gameBoard[index].toLowerCase());
                }
                
                if (!isMyTurn || gameBoard[index] || !gameActive) {
                    cell.classList.add('disabled');
                } else {
                    cell.classList.remove('disabled');
                }
            });

            // ÿ™ŸÑŸàŸäŸÜ ÿßŸÑÿÆŸÑÿßŸäÿß ÿßŸÑŸÅÿßÿ¶ÿ≤ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÅÿßÿ¶ÿ≤
            if (!gameActive) {
                highlightWinningCells();
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ± ÿßŸÑŸÑÿßÿπÿ®
        function updatePlayerTurn() {
            const playerTurn = document.getElementById('player-turn');
            
            if (!gameActive) {
                playerTurn.textContent = 'ÿßŸÑŸÑÿπÿ®ÿ© ŸÖÿ™ŸàŸÇŸÅÿ©';
                playerTurn.className = 'player-turn waiting';
            } else if (isMyTurn) {
                playerTurn.textContent = `üéÆ ÿØŸàÿ±ŸÉ! (${playerSymbol})`;
                playerTurn.className = `player-turn player-${playerSymbol.toLowerCase()}`;
            } else {
                playerTurn.textContent = `‚è≥ ÿØŸàÿ± ÿßŸÑÿÆÿµŸÖ (${currentPlayer})`;
                playerTurn.className = 'player-turn waiting';
            }
        }

        // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿÆŸÑŸäÿ©
        function handleCellClick(index) {
            if (!isMyTurn || !gameActive || gameBoard[index] !== '') return;

            const success = gameServer.makeMove(roomId, playerId, index);
            if (success) {
                updateRoomUI();
            }
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ©
        function resetGame() {
            gameServer.resetGame(roomId);
            updateRoomUI();
            hideMessages();
        }

        // ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©
        function leaveRoom() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©ÿü')) {
                window.location.href = window.location.pathname;
            }
        }

        // ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØÿπŸàÿ©
        function copyRoomLink() {
            const roomLink = window.location.origin + window.location.pathname + '?room=' + roomId;
            navigator.clipboard.writeText(roomLink).then(() => {
                alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØÿπŸàÿ©: ' + roomLink);
            });
        }

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ≠ÿßÿØÿ´ÿ©
        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (message && playerId) {
                gameServer.sendMessage(roomId, playerId, message);
                chatInput.value = '';
                updateRoomUI();
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
        function updateChat(chatMessages) {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';

            chatMessages.forEach(msg => {
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                
                const sender = document.createElement('div');
                sender.className = 'message-sender';
                sender.textContent = `${msg.playerName} (${msg.timestamp}):`;
                
                const message = document.createElement('div');
                message.textContent = msg.message;

                messageItem.appendChild(sender);
                messageItem.appendChild(message);
                chatContainer.appendChild(messageItem);
            });

            // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            status.textContent = connected ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
            status.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
        function updateURL() {
            const newUrl = window.location.origin + window.location.pathname + '?room=' + roomId;
            window.history.replaceState({}, '', newUrl);
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÅŸàÿ≤
        function showWinMessage(winner) {
            const winMessage = document.getElementById('win-message');
            const isWinner = winner === playerSymbol;
            winMessage.textContent = isWinner ? 'üéâ ŸÖÿ®ÿ±ŸàŸÉ! ŸÑŸÇÿØ ŸÅÿ≤ÿ™!' : 'üòÖ ŸÑŸÇÿØ ÿÆÿ≥ÿ±ÿ™! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
            winMessage.style.display = 'block';
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿπÿßÿØŸÑ
        function showDrawMessage() {
            document.getElementById('draw-message').style.display = 'block';
        }

        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
        function hideMessages() {
            document.getElementById('win-message').style.display = 'none';
            document.getElementById('draw-message').style.display = 'none';
        }

        // ÿ™ŸÑŸàŸäŸÜ ÿßŸÑÿÆŸÑÿßŸäÿß ÿßŸÑŸÅÿßÿ¶ÿ≤ÿ©
        function highlightWinningCells() {
            winPatterns.forEach(pattern => {
                const [a, b, c] = pattern;
                if (gameBoard[a] && gameBoard[a] === gameBoard[b] && gameBoard[a] === gameBoard[c]) {
                    pattern.forEach(index => {
                        const cell = document.querySelector(`[data-index="${index}"]`);
                        cell.classList.add('win');
                    });
                }
            });
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ©
        window.onRoomUpdate = function(room) {
            updateRoomUI();
            if (room.gameActive || room.winner) {
                updateGameState(room);
            }
        };

        // ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', function() {
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ±ÿßÿ®ÿ∑ ÿ∫ÿ±ŸÅÿ©
            const urlParams = new URLSearchParams(window.location.search);
            const joinRoomId = urlParams.get('room');

            if (joinRoomId) {
                const result = gameServer.joinRoom(joinRoomId, 'ÿßŸÑŸÑÿßÿπÿ®');
                if (result) {
                    roomId = joinRoomId;
                    playerId = result.playerId;
                    playerSymbol = result.symbol;
                    hideAllSections();
                    document.getElementById('lobby').style.display = 'block';
                    updateRoomUI();
                    initGameBoard();
                } else {
                    showError('‚ùå ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£Ÿà ŸÖŸÖÿ™ŸÑÿ¶ÿ©');
                    document.getElementById('auto-join-section').style.display = 'block';
                }
            }
        });

        // ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Enter
        document.getElementById('chat-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>