<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© XO Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† - ØªÙŠÙƒ ØªØ§Ùƒ ØªÙˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .developer-credit {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            to {
                box-shadow: 0 4px 20px rgba(78, 205, 196, 0.6);
            }
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .lobby {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .room-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .player-list {
            margin: 15px 0;
            text-align: right;
        }

        .player-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-right: 4px solid #667eea;
        }

        .player-x {
            border-right-color: #ff6b6b;
        }

        .player-o {
            border-right-color: #4ecdc4;
        }

        .player-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .player-turn {
            font-size: 1.3em;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .player-x {
            background: #ff6b6b;
            color: white;
        }

        .player-o {
            background: #4ecdc4;
            color: white;
        }

        .waiting {
            background: #ffc107;
            color: black;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin: 20px 0;
            background: #333;
            padding: 10px;
            border-radius: 10px;
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cell:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .cell.x {
            color: #ff6b6b;
        }

        .cell.o {
            color: #4ecdc4;
        }

        .cell.win {
            background: #fff3cd;
            animation: pulse 0.5s ease-in-out;
        }

        .cell.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: #dc3545;
        }

        .reset-btn:hover {
            background: #c82333;
        }

        .invite-btn {
            background: #28a745;
        }

        .invite-btn:hover {
            background: #218838;
        }

        .message {
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .win-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .draw-message {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: none;
            margin: 10px 0;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-container {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .chat-input button {
            padding: 10px 20px;
        }

        .message-item {
            margin: 5px 0;
            padding: 8px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .message-sender {
            font-weight: bold;
            color: #667eea;
        }

        .footer {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .auto-join-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #b3d9ff;
        }

        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ù‡ÙˆØ§ØªÙ */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .cell {
                font-size: 2.5em;
            }
            
            button {
                padding: 10px 20px;
                font-size: 1em;
            }
            
            .connection-status {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
            }

            .developer-credit {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">
        ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„
    </div>

    <div class="container">
        <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ± -->
        <div class="developer-credit">
            ğŸš€ Ù…Ø·ÙˆØ± Ø§Ù„Ù„Ø¹Ø¨Ø©: ÙƒØ±Ø§Ø±
        </div>

        <h1>ğŸ® Ù„Ø¹Ø¨Ø© XO Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h1>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
        <div class="auto-join-section" id="auto-join-section">
            <h3>ğŸ¯ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h3>
            <div class="controls">
                <button onclick="createNewRoom()">ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button onclick="joinRandomRoom()">ğŸ² Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</button>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>
        
        <div class="lobby" id="lobby" style="display: none;">
            <h3>ğŸ‘¥ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h3>
            <div class="room-code" id="room-code">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...</div>
            
            <div class="player-list" id="player-list">
                <div class="player-item waiting">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>
            </div>
            
            <button class="invite-btn" onclick="copyRoomLink()" id="invite-btn">
                ğŸ“§ Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚
            </button>
        </div>

        <div class="player-info" id="game-info" style="display: none;">
            <div class="player-turn waiting" id="player-turn">Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
        </div>

        <div class="game-board" id="board" style="display: none;">
            <!-- Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
        </div>

        <div class="message win-message" id="win-message"></div>
        <div class="message draw-message" id="draw-message">ØªØ¹Ø§Ø¯Ù„! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>

        <div class="controls" id="game-controls" style="display: none;">
            <button onclick="resetGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
            <button class="reset-btn" onclick="leaveRoom()">ğŸ”„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
        </div>

        <div class="chat-container" id="chat-container" style="display: none;">
            <h4>ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØºØ±ÙØ©</h4>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." maxlength="100">
                <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
        <div class="footer">
            <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <strong>ÙƒØ±Ø§Ø±</strong> | Ù„Ø¹Ø¨Ø© XO Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>
            <p>ğŸ’» Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ!</p>
        </div>
    </div>

    <script>
        // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentPlayer = 'X';
        let gameBoard = ['', '', '', '', '', '', '', '', ''];
        let gameActive = false;
        let playerId = null;
        let playerSymbol = null;
        let roomId = null;
        let players = [];
        let isMyTurn = false;

        // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ÙÙˆØ²
        const winPatterns = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // ØµÙÙˆÙ
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Ø£Ø¹Ù…Ø¯Ø©
            [0, 4, 8], [2, 4, 6]             // Ø£Ù‚Ø·Ø§Ø±
        ];

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø®Ø§Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
        class GameServer {
            constructor() {
                this.rooms = new Map();
                this.setupStorageListener();
                this.loadFromStorage();
            }

            // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
            createRoom() {
                const roomId = this.generateRoomId();
                const room = {
                    id: roomId,
                    players: [],
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'X',
                    gameActive: false,
                    winner: null,
                    chat: [],
                    createdAt: new Date().toISOString()
                };
                
                this.rooms.set(roomId, room);
                this.saveToStorage();
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©:', roomId);
                return roomId;
            }

            // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©
            joinRoom(roomId, playerName) {
                const room = this.rooms.get(roomId);
                if (!room) {
                    console.log('âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', roomId);
                    return null;
                }

                if (room.players.length >= 2) {
                    console.log('âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©:', roomId);
                    return null;
                }

                const playerId = this.generatePlayerId();
                const player = {
                    id: playerId,
                    name: playerName || `Ù„Ø§Ø¹Ø¨ ${room.players.length + 1}`,
                    symbol: room.players.length === 0 ? 'X' : 'O'
                };

                room.players.push(player);
                
                if (room.players.length === 2) {
                    room.gameActive = true;
                }

                this.saveToStorage();
                console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:', roomId, 'Ø§Ù„Ù„Ø§Ø¹Ø¨:', player.name);
                return { playerId, symbol: player.symbol, room };
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ© Ù…ØªØ§Ø­Ø©
            findAvailableRoom() {
                const now = new Date();
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø¯Ù‚Ø§Ø¦Ù‚)
                this.cleanOldRooms();

                for (let [roomId, room] of this.rooms) {
                    if (room.players.length === 1 && !room.gameActive) {
                        // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„ØºØ±ÙØ© Ù„ÙŠØ³Øª Ù‚Ø¯ÙŠÙ…Ø©
                        const roomAge = now - new Date(room.createdAt);
                        if (roomAge < 10 * 60 * 1000) { // 10 Ø¯Ù‚Ø§Ø¦Ù‚
                            console.log('ğŸ¯ ÙˆØ¬Ø¯Øª ØºØ±ÙØ© Ù…ØªØ§Ø­Ø©:', roomId);
                            return roomId;
                        }
                    }
                }
                console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ØªØ§Ø­Ø©');
                return null;
            }

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            cleanOldRooms() {
                const now = new Date();
                for (let [roomId, room] of this.rooms) {
                    const roomAge = now - new Date(room.createdAt);
                    if (roomAge > 30 * 60 * 1000) { // 30 Ø¯Ù‚ÙŠÙ‚Ø©
                        this.rooms.delete(roomId);
                        console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ ØºØ±ÙØ© Ù‚Ø¯ÙŠÙ…Ø©:', roomId);
                    }
                }
                this.saveToStorage();
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            makeMove(roomId, playerId, cellIndex) {
                const room = this.rooms.get(roomId);
                if (!room || !room.gameActive) return false;

                const player = room.players.find(p => p.id === playerId);
                if (!player || player.symbol !== room.currentPlayer) return false;

                if (room.board[cellIndex] !== '') return false;

                room.board[cellIndex] = player.symbol;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
                if (this.checkWin(room.board)) {
                    room.winner = player.symbol;
                    room.gameActive = false;
                } else if (this.checkDraw(room.board)) {
                    room.winner = 'draw';
                    room.gameActive = false;
                } else {
                    room.currentPlayer = room.currentPlayer === 'X' ? 'O' : 'X';
                }

                this.saveToStorage();
                return true;
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
            resetGame(roomId) {
                const room = this.rooms.get(roomId);
                if (!room) return false;

                room.board = ['', '', '', '', '', '', '', '', ''];
                room.currentPlayer = 'X';
                room.winner = null;
                room.gameActive = room.players.length === 2;

                this.saveToStorage();
                return true;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø©
            sendMessage(roomId, playerId, message) {
                const room = this.rooms.get(roomId);
                if (!room) return false;

                const player = room.players.find(p => p.id === playerId);
                if (!player) return false;

                room.chat.push({
                    playerId,
                    playerName: player.name,
                    message,
                    timestamp: new Date().toLocaleTimeString()
                });

                // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
                if (room.chat.length > 50) {
                    room.chat = room.chat.slice(-50);
                }

                this.saveToStorage();
                return true;
            }

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±ÙØ©
            getRoomUpdate(roomId) {
                return this.rooms.get(roomId);
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ØºØ±ÙØ©
            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ù„Ø§Ø¹Ø¨
            generatePlayerId() {
                return Math.random().toString(36).substring(2, 10);
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
            checkWin(board) {
                return winPatterns.some(pattern => {
                    const [a, b, c] = pattern;
                    return board[a] && board[a] === board[b] && board[a] === board[c];
                });
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø¯Ù„
            checkDraw(board) {
                return board.every(cell => cell !== '');
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø­ÙØ¸ ÙÙŠ LocalStorage
            saveToStorage() {
                const roomsObj = Object.fromEntries(this.rooms);
                localStorage.setItem('xo_online_rooms', JSON.stringify(roomsObj));
            }

            // Ù…Ø³Ø§Ø¹Ø¯Ø© - ØªØ­Ù…ÙŠÙ„ Ù…Ù† LocalStorage
            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('xo_online_rooms');
                    if (stored) {
                        const roomsObj = JSON.parse(stored);
                        this.rooms = new Map(Object.entries(roomsObj));
                        console.log('ğŸ“‚ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†:', this.rooms.size);
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    this.rooms = new Map();
                }
            }

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª LocalStorage (Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
            setupStorageListener() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'xo_online_rooms' && roomId) {
                        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†');
                        this.onRoomUpdate(roomId);
                    }
                });

                // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                setInterval(() => {
                    if (roomId) {
                        this.onRoomUpdate(roomId);
                    }
                }, 1000);
            }

            onRoomUpdate(roomId) {
                const room = this.getRoomUpdate(roomId);
                if (room && window.onRoomUpdate) {
                    window.onRoomUpdate(room);
                }
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
        const gameServer = new GameServer();

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        function createNewRoom() {
            hideAllSections();
            document.getElementById('lobby').style.display = 'block';
            
            roomId = gameServer.createRoom();
            const result = gameServer.joinRoom(roomId, 'Ø§Ù„Ù„Ø§Ø¹Ø¨ 1');
            
            if (result) {
                playerId = result.playerId;
                playerSymbol = result.symbol;
                updateRoomUI();
                updateURL();
                initGameBoard();
            } else {
                showError('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        function joinRandomRoom() {
            hideAllSections();
            
            const availableRoom = gameServer.findAvailableRoom();
            if (availableRoom) {
                const result = gameServer.joinRoom(availableRoom, 'Ø§Ù„Ù„Ø§Ø¹Ø¨ 2');
                if (result) {
                    roomId = availableRoom;
                    playerId = result.playerId;
                    playerSymbol = result.symbol;
                    updateRoomUI();
                    updateURL();
                    initGameBoard();
                    showError('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    showError('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©');
                    createNewRoom(); // Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                }
            } else {
                showError('ğŸ¯ Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ØªØ§Ø­Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©...');
                createNewRoom(); // Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            }
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        function hideAllSections() {
            document.getElementById('auto-join-section').style.display = 'none';
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-info').style.display = 'none';
            document.getElementById('board').style.display = 'none';
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
        }

        // ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function initGameBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = 'cell';
                cell.setAttribute('data-index', i);
                cell.addEventListener('click', () => handleCellClick(i));
                board.appendChild(cell);
            }

            updateConnectionStatus(true);
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ©
        function updateRoomUI() {
            const room = gameServer.getRoomUpdate(roomId);
            if (!room) {
                showError('âŒ Ø§Ù„ØºØ±ÙØ© Ù„Ù… ØªØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return;
            }

            document.getElementById('room-code').textContent = room.id;
            updatePlayerList(room.players);
            
            if (room.players.length === 2 && room.gameActive) {
                startGame(room);
            } else {
                showWaitingMessage();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        function updatePlayerList(players) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';

            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item player-${player.symbol.toLowerCase()}`;
                playerItem.textContent = `${player.name} (${player.symbol})`;
                if (player.id === playerId) {
                    playerItem.textContent += ' - Ø£Ù†Øª';
                }
                playerList.appendChild(playerItem);
            });

            if (players.length === 1) {
                const waitingItem = document.createElement('div');
                waitingItem.className = 'player-item waiting';
                waitingItem.textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...';
                playerList.appendChild(waitingItem);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function startGame(room) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-info').style.display = 'block';
            document.getElementById('board').style.display = 'grid';
            document.getElementById('game-controls').style.display = 'block';
            document.getElementById('chat-container').style.display = 'block';

            gameActive = room.gameActive;
            updateGameState(room);
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        function showWaitingMessage() {
            document.getElementById('player-turn').textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...';
            document.getElementById('player-turn').className = 'player-turn waiting';
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function updateGameState(room) {
            gameBoard = [...room.board];
            currentPlayer = room.currentPlayer;
            isMyTurn = room.gameActive && room.players.find(p => p.id === playerId)?.symbol === room.currentPlayer;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©
            updateBoard();

            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨
            updatePlayerTurn();

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙˆØ²/Ø§Ù„ØªØ¹Ø§Ø¯Ù„
            if (room.winner) {
                if (room.winner === 'draw') {
                    showDrawMessage();
                } else {
                    showWinMessage(room.winner);
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            updateChat(room.chat);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©
        function updateBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                cell.textContent = gameBoard[index];
                cell.className = 'cell';
                
                if (gameBoard[index]) {
                    cell.classList.add(gameBoard[index].toLowerCase());
                }
                
                if (!isMyTurn || gameBoard[index] || !gameActive) {
                    cell.classList.add('disabled');
                } else {
                    cell.classList.remove('disabled');
                }
            });

            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø¦Ø²Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙØ§Ø¦Ø²
            if (!gameActive) {
                highlightWinningCells();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨
        function updatePlayerTurn() {
            const playerTurn = document.getElementById('player-turn');
            
            if (!gameActive) {
                playerTurn.textContent = 'Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ØªÙˆÙ‚ÙØ©';
                playerTurn.className = 'player-turn waiting';
            } else if (isMyTurn) {
                playerTurn.textContent = `ğŸ® Ø¯ÙˆØ±Ùƒ! (${playerSymbol})`;
                playerTurn.className = `player-turn player-${playerSymbol.toLowerCase()}`;
            } else {
                playerTurn.textContent = `â³ Ø¯ÙˆØ± Ø§Ù„Ø®ØµÙ… (${currentPlayer})`;
                playerTurn.className = 'player-turn waiting';
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ©
        function handleCellClick(index) {
            if (!isMyTurn || !gameActive || gameBoard[index] !== '') return;

            const success = gameServer.makeMove(roomId, playerId, index);
            if (success) {
                updateRoomUI();
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
        function resetGame() {
            gameServer.resetGame(roomId);
            updateRoomUI();
            hideMessages();
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©
        function leaveRoom() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                window.location.href = window.location.pathname;
            }
        }

        // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
        function copyRoomLink() {
            const roomLink = window.location.origin + window.location.pathname + '?room=' + roomId;
            navigator.clipboard.writeText(roomLink).then(() => {
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©: ' + roomLink);
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø©
        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (message && playerId) {
                gameServer.sendMessage(roomId, playerId, message);
                chatInput.value = '';
                updateRoomUI();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function updateChat(chatMessages) {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';

            chatMessages.forEach(msg => {
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                
                const sender = document.createElement('div');
                sender.className = 'message-sender';
                sender.textContent = `${msg.playerName} (${msg.timestamp}):`;
                
                const message = document.createElement('div');
                message.textContent = msg.message;

                messageItem.appendChild(sender);
                messageItem.appendChild(message);
                chatContainer.appendChild(messageItem);
            });

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            status.textContent = connected ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
            status.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        function updateURL() {
            const newUrl = window.location.origin + window.location.pathname + '?room=' + roomId;
            window.history.replaceState({}, '', newUrl);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙˆØ²
        function showWinMessage(winner) {
            const winMessage = document.getElementById('win-message');
            const isWinner = winner === playerSymbol;
            winMessage.textContent = isWinner ? 'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ÙØ²Øª!' : 'ğŸ˜… Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
            winMessage.style.display = 'block';
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„
        function showDrawMessage() {
            document.getElementById('draw-message').style.display = 'block';
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function hideMessages() {
            document.getElementById('win-message').style.display = 'none';
            document.getElementById('draw-message').style.display = 'none';
        }

        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø¦Ø²Ø©
        function highlightWinningCells() {
            winPatterns.forEach(pattern => {
                const [a, b, c] = pattern;
                if (gameBoard[a] && gameBoard[a] === gameBoard[b] && gameBoard[a] === gameBoard[c]) {
                    pattern.forEach(index => {
                        const cell = document.querySelector(`[data-index="${index}"]`);
                        cell.classList.add('win');
                    });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±ÙØ©
        window.onRoomUpdate = function(room) {
            updateRoomUI();
            if (room.gameActive || room.winner) {
                updateGameState(room);
            }
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØºØ±ÙØ©
            const urlParams = new URLSearchParams(window.location.search);
            const joinRoomId = urlParams.get('room');

            if (joinRoomId) {
                const result = gameServer.joinRoom(joinRoomId, 'Ø§Ù„Ù„Ø§Ø¹Ø¨');
                if (result) {
                    roomId = joinRoomId;
                    playerId = result.playerId;
                    playerSymbol = result.symbol;
                    hideAllSections();
                    document.getElementById('lobby').style.display = 'block';
                    updateRoomUI();
                    initGameBoard();
                } else {
                    showError('âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ù…Ù…ØªÙ„Ø¦Ø©');
                    document.getElementById('auto-join-section').style.display = 'block';
                }
            }
        });

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.getElementById('chat-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>